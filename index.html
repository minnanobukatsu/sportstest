<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>みんなのスポーツテスト</title>
    
    <!-- Tailwind CSS (デザイン用) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (アプリの基本) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (ブラウザでReactを動かす用) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Rechartsの依存ライブラリ -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    
    <!-- Recharts (グラフ描画用 - 安定版を指定) -->
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>

    <style>
        body { background-color: #f1f5f9; color: #334155; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }
        .btn-press:active { transform: scale(0.98); }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.2s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const RechartsObj = window.Recharts || {};
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Radar, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis } = RechartsObj;

        // --- アイコン定義 (SVG) ---
        const IconUser = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const IconUsers = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
        const IconTrophy = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>;
        const IconActivity = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>;
        const IconHistory = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/><path d="M12 7v5l3 3"/></svg>;
        const IconPlus = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>;
        const IconSettings = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>;
        const IconUserPlus = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>;
        const IconArrowLeft = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>;
        const IconTrash = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
        const IconAlert = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>;
        const IconHome = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>;
        const IconCheck = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>;
        const IconEye = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>;
        const IconEyeOff = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" y1="2" x2="22" y2="22"/></svg>;
        const IconSave = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
        const IconTrendingUp = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>;
        const IconCalendar = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>;
        const IconDown = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6 9 12 15 18 9"/></svg>;
        const IconChevronRight = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="9 18 15 12 9 6"/></svg>;
        const IconHelp = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>;
        const IconX = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>;

        // --- データ管理 (LocalStorage) ---
        const DB_KEY_PROFILES = 'sports_test_profiles';
        const DB_KEY_RECORDS = 'sports_test_records';
        const DB_KEY_ITEMS = 'sports_test_items';
        const DB_KEY_TUTORIAL_DONE = 'sports_test_tutorial_done'; // チュートリアル完了フラグ

        const getLocalData = (key, defaultVal = []) => {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultVal;
            } catch (e) {
                console.error(e);
                return defaultVal;
            }
        };

        const setLocalData = (key, data) => {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error(e);
                alert('データ保存容量が一杯です。古いデータを削除してください。');
            }
        };

        // --- 定数 ---
        const CATEGORIES = {
            member: '会員 (年長〜小6)',
            sibling: '兄弟・姉妹',
            parent: '保護者'
        };

        const DEFAULT_ITEMS = [
            { id: 'courtSprint', label: 'バスケットコート走', unit: '秒', type: 'lower_is_better', group: '走力', active: true, order: 1 },
            { id: 'courtShuttle', label: 'バスケットコートシャトル走', unit: '秒', type: 'lower_is_better', group: '走力', active: true, order: 2 },
            { id: 'sideSteps', label: '20秒反復横跳び', unit: '回', type: 'higher_is_better', group: '敏捷性', active: true, order: 3 },
            { id: 'sitUps', label: '30秒上体起こし', unit: '回', type: 'higher_is_better', group: '筋力', active: true, order: 4 },
            { id: 'trunkExtension', label: '上体反らし', unit: 'cm', type: 'higher_is_better', group: '柔軟性', active: true, order: 5 },
            { id: 'verticalJump', label: '垂直跳び', unit: 'cm', type: 'higher_is_better', group: '跳躍力', active: true, order: 6 },
            { id: 'standingLongJump', label: '立ち幅跳び', unit: 'cm', type: 'higher_is_better', group: '跳躍力', active: true, order: 7 },
            { id: 'runningLongJump', label: '走り幅跳び', unit: 'cm', type: 'higher_is_better', group: '跳躍力', active: true, order: 8 },
            { id: 'ballThrow', label: 'バスケットボール投げ', unit: 'm', type: 'higher_is_better', group: '投力', active: true, order: 9 },
            { id: 'origamiTotal', label: '折り紙キャッチ(合計)', unit: '回', type: 'higher_is_better', group: '器用さ', active: true, order: 10 },
        ];

        const GROUPS = ['走力', '敏捷性', '筋力', '柔軟性', '跳躍力', '投力', '器用さ', 'その他'];

        // --- ロジック ---
        // 生年月日から年齢・学年を計算する関数
        const calculateAgeInfo = (birthDateStr) => {
            if (!birthDateStr) return { age: null, grade: '', label: '' };

            const birthDate = new Date(birthDateStr);
            const today = new Date();
            
            // 満年齢計算
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }

            // 学年計算 (日本の学校制度: 4/2生まれ〜翌4/1生まれ)
            const currentYear = today.getFullYear();
            const currentFiscalYear = (today.getMonth() + 1) >= 4 ? currentYear : currentYear - 1;

            let birthYear = birthDate.getFullYear();
            const birthMonth = birthDate.getMonth() + 1;
            const birthDay = birthDate.getDate();
            
            // 早生まれ(1/1~4/1)の場合は年度としては前年生まれ扱い
            let birthFiscalYear = birthYear;
            if (birthMonth < 4 || (birthMonth === 4 && birthDay === 1)) {
                birthFiscalYear = birthYear - 1;
            }

            const yearDiff = currentFiscalYear - birthFiscalYear;
            
            let grade = '';
            if (yearDiff === 6) grade = '年長';
            else if (yearDiff === 7) grade = '小1';
            else if (yearDiff === 8) grade = '小2';
            else if (yearDiff === 9) grade = '小3';
            else if (yearDiff === 10) grade = '小4';
            else if (yearDiff === 11) grade = '小5';
            else if (yearDiff === 12) grade = '小6';
            else if (yearDiff === 13) grade = '中1';
            else if (yearDiff === 14) grade = '中2';
            else if (yearDiff === 15) grade = '中3';
            else if (yearDiff >= 16 && yearDiff <= 18) grade = '高校生';
            else if (yearDiff > 18) grade = '大人';
            else grade = '未就学';

            const label = `${age}歳 / ${grade}`;
            return { age, grade, label };
        };

        const parseAge = (ageStr) => {
            if (!ageStr) return 10;
            // 互換性のため、文字列から数値を抽出して返す
            const match = ageStr.match(/\d+/);
            if (match) return parseInt(match[0], 10);
            return 10;
        };

        const getTargetValue = (itemId, age, gender) => {
            const effectiveAge = Math.min(18, Math.max(6, age));
            const isMale = gender === 'male';
            const growthFactor = effectiveAge - 6;

            switch (itemId) {
                case 'courtSprint': return Math.max(4.0, 10.0 - (growthFactor * 0.4));
                case 'courtShuttle': return Math.max(8.0, 16.0 - (growthFactor * 0.5));
                case 'sideSteps': return 25 + (growthFactor * (isMale ? 3.5 : 3.0));
                case 'sitUps': return 12 + (growthFactor * 2.0);
                case 'trunkExtension': return 30 + (growthFactor * 2.0);
                case 'verticalJump': return 25 + (growthFactor * (isMale ? 3.5 : 2.5));
                case 'standingLongJump': return 115 + (growthFactor * (isMale ? 12 : 10));
                case 'runningLongJump': return 200 + (growthFactor * 15);
                case 'ballThrow': return 8 + (growthFactor * (isMale ? 3.0 : 2.0));
                case 'origamiTotal': return 10;
                default: return 100;
            }
        };

        const calculateScore = (val, item, age, gender) => {
            if (val === null || val === undefined) return 0;
            const target = getTargetValue(item.id, age, gender);
            let score = 0;
            if (item.type === 'lower_is_better') {
                if (val <= target) return 100;
                const zeroPoint = target * 2.5;
                score = ((zeroPoint - val) / (zeroPoint - target)) * 100;
            } else {
                score = (val / target) * 100;
            }
            return Math.min(100, Math.max(0, score));
        };

        // --- 共通コンポーネント ---
        const InputGroup = ({ label, suffix, placeholder, value, onChange }) => (
            <div>
                <label className="block text-sm font-medium text-slate-700 mb-1 flex items-center gap-2">{label}</label>
                <div className="relative">
                    <input
                        type="number"
                        step="0.1"
                        className="w-full p-3 pr-10 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none font-medium text-lg placeholder:text-slate-300"
                        placeholder={placeholder}
                        value={value}
                        onChange={(e) => onChange(e.target.value)}
                    />
                    <span className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm font-medium">{suffix}</span>
                </div>
            </div>
        );

        const StatBox = ({ label, value }) => (
            <div className="bg-slate-50 p-3 rounded-lg border border-slate-100">
                <div className="text-[10px] text-slate-500 mb-0.5 truncate">{label}</div>
                <div className="text-lg font-bold text-slate-800">{value}</div>
            </div>
        );

        const NavButton = ({ icon, label, active, onClick }) => (
          <button 
            onClick={onClick}
            className={`flex flex-col items-center gap-1 w-16 transition-colors duration-200 ${active ? 'text-green-600' : 'text-slate-400 hover:text-slate-600'}`}
          >
            {icon}
            <span className="text-[10px] font-bold">{label}</span>
          </button>
        );

        const HelpModal = ({ onClose }) => (
            <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in backdrop-blur-sm" onClick={onClose}>
                <div className="bg-white rounded-2xl w-full max-w-md max-h-[85vh] overflow-y-auto shadow-2xl flex flex-col" onClick={e => e.stopPropagation()}>
                    <div className="p-4 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10">
                        <h3 className="font-bold text-lg flex items-center gap-2 text-slate-800">
                            <IconHelp className="text-green-600" /> 使い方ガイド
                        </h3>
                        <button onClick={onClose} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition">
                            <IconX className="w-5 h-5 text-slate-500" />
                        </button>
                    </div>
                    <div className="p-6 space-y-8 text-slate-600">
                        <section>
                            <h4 className="font-bold text-green-700 mb-2 flex items-center gap-2">
                                <span className="bg-green-100 w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
                                メンバーを登録する
                            </h4>
                            <p className="text-sm leading-relaxed">
                                右上の <IconUserPlus className="inline w-4 h-4 text-green-600 mx-1" /> ボタンから、参加する人（お子様や保護者）を登録しましょう。年齢や性別を入れると、評価基準が自動で設定されます。
                            </p>
                        </section>

                        <section>
                            <h4 className="font-bold text-green-700 mb-2 flex items-center gap-2">
                                <span className="bg-green-100 w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
                                記録を入力する
                            </h4>
                            <p className="text-sm leading-relaxed mb-2">
                                下のメニューの「記録する」ボタンを押して記録を入力します。
                            </p>
                            <ul className="list-disc list-inside text-xs bg-slate-50 p-3 rounded-lg space-y-1">
                                <li><strong>ひとりで記録:</strong> 現在選んでいるメンバーの記録をつけます。</li>
                                <li><strong>みんなで記録:</strong> 家族など複数人の記録を、画面を切り替えずにまとめて入力できます。</li>
                            </ul>
                        </section>

                        <section>
                            <h4 className="font-bold text-green-700 mb-2 flex items-center gap-2">
                                <span className="bg-green-100 w-6 h-6 rounded-full flex items-center justify-center text-xs">3</span>
                                成長を確認する
                            </h4>
                            <p className="text-sm leading-relaxed">
                                ホーム画面では、<strong>レーダーチャート</strong>で能力バランスを、<strong>折れ線グラフ</strong>で成長の履歴を確認できます。<br/>
                                右上のメンバーボタンで表示する人を切り替えられます。
                            </p>
                        </section>
                    </div>
                    <div className="p-4 border-t border-slate-100 mt-auto">
                        <button onClick={onClose} className="w-full py-3 bg-green-600 text-white font-bold rounded-xl shadow-lg btn-press">
                            はじめる
                        </button>
                    </div>
                </div>
            </div>
        );

        // --- メインコンポーネント ---
        function App() {
            const [profiles, setProfiles] = useState([]);
            const [records, setRecords] = useState([]);
            const [testItems, setTestItems] = useState([]);
            const [selectedProfileId, setSelectedProfileId] = useState(null);
            const [view, setView] = useState('loading');
            const [autoCreateMode, setAutoCreateMode] = useState(false);
            const [showHelp, setShowHelp] = useState(false);

            // 初期データロード
            useEffect(() => {
                const loadedProfiles = getLocalData(DB_KEY_PROFILES, []);
                const loadedRecords = getLocalData(DB_KEY_RECORDS, []);
                let loadedItems = getLocalData(DB_KEY_ITEMS, []);

                if (loadedItems.length === 0) {
                    loadedItems = DEFAULT_ITEMS;
                    setLocalData(DB_KEY_ITEMS, loadedItems);
                }

                setProfiles(loadedProfiles);
                setRecords(loadedRecords);
                setTestItems(loadedItems);

                // チュートリアル確認
                const tutorialDone = localStorage.getItem(DB_KEY_TUTORIAL_DONE);
                if (!tutorialDone) {
                    setShowHelp(true);
                }

                if (loadedProfiles.length > 0) {
                    setSelectedProfileId(loadedProfiles[0].id);
                    setView('dashboard');
                } else {
                    setView('profiles');
                }
            }, []);

            const updateProfiles = (newProfiles) => {
                setProfiles(newProfiles);
                setLocalData(DB_KEY_PROFILES, newProfiles);
            };

            const updateRecords = (newRecords) => {
                setRecords(newRecords);
                setLocalData(DB_KEY_RECORDS, newRecords);
            };

            const updateTestItems = (newItems) => {
                setTestItems(newItems);
                setLocalData(DB_KEY_ITEMS, newItems);
            };

            const handleProfileSelect = (id) => {
                setSelectedProfileId(id);
                setView('dashboard');
            };

            const handleLogoClick = () => {
                const exists = profiles.find(p => p.id === selectedProfileId);
                if (exists) {
                    setView('dashboard');
                } else if (profiles.length > 0) {
                    setSelectedProfileId(profiles[0].id);
                    setView('dashboard');
                } else {
                    setView('profiles');
                }
            };

            const handleCloseHelp = () => {
                setShowHelp(false);
                // Set flag so it doesn't show again automatically
                localStorage.setItem(DB_KEY_TUTORIAL_DONE, 'true');
            };

            const currentProfile = profiles.find(p => p.id === selectedProfileId);

            if (view === 'loading') return <div className="h-screen flex items-center justify-center bg-slate-50"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600"></div></div>;

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-20">
                    {/* Header */}
                    <header className="bg-white text-slate-800 p-3 shadow-sm sticky top-0 z-30 border-b border-slate-100">
                        <div className="max-w-3xl mx-auto flex justify-between items-center">
                            {/* Logo / Home Link */}
                            <div className="flex items-center gap-2 cursor-pointer" onClick={handleLogoClick}>
                                <div className="bg-green-600 text-white p-1.5 rounded-lg">
                                    <IconTrophy className="h-5 w-5" />
                                </div>
                                <h1 className="text-lg font-bold tracking-tight text-slate-800 hidden sm:block">みんなのスポーツテスト</h1>
                                <h1 className="text-lg font-bold tracking-tight text-slate-800 sm:hidden">スポテス</h1>
                            </div>

                            {/* Right Actions */}
                            <div className="flex items-center gap-2">
                                {/* Help Button (New) */}
                                <button 
                                    onClick={() => setShowHelp(true)} 
                                    className="p-2 text-slate-400 hover:text-green-600 hover:bg-slate-50 rounded-full transition"
                                    title="使い方"
                                >
                                    <IconHelp className="w-6 h-6" />
                                </button>

                                {/* Settings */}
                                <button 
                                    onClick={() => setView('settings')} 
                                    className="p-2 text-slate-400 hover:text-green-600 hover:bg-slate-50 rounded-full transition"
                                    title="設定"
                                >
                                    <IconSettings className="w-6 h-6" />
                                </button>

                                {/* Member Switcher / Add */}
                                <button 
                                    onClick={() => setView('profiles')} 
                                    className={`flex items-center gap-2 pl-1 pr-3 py-1 rounded-full border transition ${view === 'profiles' ? 'bg-green-50 border-green-200 text-green-700' : 'bg-white border-slate-200 text-slate-600 hover:border-green-300'}`}
                                    title="メンバー確認・追加"
                                >
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white ${currentProfile ? (currentProfile.gender === 'male' ? 'bg-blue-400' : 'bg-pink-400') : 'bg-slate-300'}`}>
                                        {currentProfile ? currentProfile.name[0] : <IconUser className="w-5 h-5" />}
                                    </div>
                                    <div className="flex flex-col items-start">
                                        <span className="text-xs font-bold leading-none max-w-[80px] truncate">
                                            {currentProfile ? currentProfile.name : 'ゲスト'}
                                        </span>
                                        <span className="text-[10px] text-slate-400 leading-none mt-0.5">メンバー管理</span>
                                    </div>
                                    <IconChevronRight className="w-4 h-4 text-slate-300" />
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Content */}
                    <main className="max-w-3xl mx-auto p-4">
                        {view === 'profiles' && (
                            <ProfileManager
                                profiles={profiles}
                                onUpdate={updateProfiles}
                                onSelect={handleProfileSelect}
                                onGroupRecord={() => setView('group_entry')}
                                initialCreateMode={autoCreateMode}
                                onModeReset={() => setAutoCreateMode(false)}
                            />
                        )}
                        {view === 'group_entry' && (
                            <GroupRecordView
                                profiles={profiles}
                                testItems={testItems}
                                onBack={() => setView('profiles')}
                                onComplete={(id) => { setSelectedProfileId(id); setView('dashboard'); }}
                                currentRecords={records}
                                onUpdateRecords={updateRecords}
                            />
                        )}
                        {view === 'dashboard' && currentProfile && (
                            <Dashboard
                                profile={currentProfile}
                                testItems={testItems}
                                records={records.filter(r => r.profileId === currentProfile.id)}
                                onRecord={() => setView('entry')}
                                onGroupRecord={() => setView('group_entry')}
                                multiProfiles={profiles.length > 1}
                            />
                        )}
                        {view === 'entry' && currentProfile && (
                            <RecordEntry
                                profile={currentProfile}
                                testItems={testItems}
                                onBack={() => setView('dashboard')}
                                onComplete={() => setView('dashboard')}
                                currentRecords={records}
                                onUpdateRecords={updateRecords}
                            />
                        )}
                        {view === 'history' && currentProfile && (
                            <HistoryView
                                profile={currentProfile}
                                testItems={testItems}
                                records={records.filter(r => r.profileId === currentProfile.id)}
                                onBack={() => setView('dashboard')}
                                onUpdateRecords={updateRecords}
                                allRecords={records}
                            />
                        )}
                        {view === 'settings' && (
                            <SettingsView
                                testItems={testItems}
                                onUpdate={updateTestItems}
                                onBack={() => selectedProfileId ? setView('dashboard') : setView('profiles')}
                            />
                        )}
                    </main>

                    {/* Help Modal */}
                    {showHelp && <HelpModal onClose={handleCloseHelp} />}

                    {/* Bottom Nav (入力画面では隠す) */}
                    {selectedProfileId && view !== 'profiles' && view !== 'settings' && view !== 'group_entry' && view !== 'entry' && (
                        <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-lg safe-area-pb z-20">
                            <div className="max-w-3xl mx-auto flex justify-around p-2">
                                <NavButton icon={<IconHome className="w-6 h-6" />} label="ホーム" active={view === 'dashboard'} onClick={() => setView('dashboard')} />
                                <NavButton icon={<IconPlus className="w-6 h-6 bg-green-600 text-white rounded-full p-0.5" />} label="記録する" active={view === 'entry'} onClick={() => setView('entry')} />
                                <NavButton icon={<IconHistory className="w-6 h-6" />} label="履歴" active={view === 'history'} onClick={() => setView('history')} />
                                <NavButton icon={<IconUsers className="w-6 h-6" />} label="メンバー" active={view === 'profiles'} onClick={() => setView('profiles')} />
                                <NavButton icon={<IconSettings className="w-6 h-6" />} label="設定" active={view === 'settings'} onClick={() => setView('settings')} />
                            </div>
                        </nav>
                    )}
                </div>
            );
        }

        // --- サブコンポーネント ---

        function ProfileManager({ profiles, onUpdate, onSelect, onGroupRecord, initialCreateMode, onModeReset }) {
            const [isCreating, setIsCreating] = useState(false);
            const [formData, setFormData] = useState({ name: '', birthdate: '', category: 'member', gender: 'male' });
            const [calculatedInfo, setCalculatedInfo] = useState({ label: '' });
            const [deleteConfirmId, setDeleteConfirmId] = useState(null);

            useEffect(() => {
                if (initialCreateMode) {
                    setIsCreating(true);
                    onModeReset();
                }
            }, [initialCreateMode, onModeReset]);

            // 生年月日が変わったら年齢・学年を再計算
            useEffect(() => {
                if (formData.birthdate) {
                    const info = calculateAgeInfo(formData.birthdate);
                    setCalculatedInfo(info);
                } else {
                    setCalculatedInfo({ label: '' });
                }
            }, [formData.birthdate]);

            const handleCreate = (e) => {
                e.preventDefault();
                if (!formData.name || !formData.birthdate) return;
                
                // ageフィールドには計算済みの文字列（例: "10歳 / 小4"）を入れておく
                const newProfile = { 
                    ...formData, 
                    age: calculatedInfo.label, 
                    id: 'u_' + Date.now(), 
                    createdAt: Date.now() 
                };
                
                onUpdate([newProfile, ...profiles]);
                setIsCreating(false);
                setFormData({ name: '', birthdate: '', category: 'member', gender: 'male' });
                onSelect(newProfile.id);
            };

            const handleDelete = (id, e) => {
                e.stopPropagation();
                if (deleteConfirmId === id) {
                    onUpdate(profiles.filter(p => p.id !== id));
                    setDeleteConfirmId(null);
                } else {
                    setDeleteConfirmId(id);
                    setTimeout(() => setDeleteConfirmId(null), 3000);
                }
            };

            if (isCreating) {
                return (
                    <div className="bg-white rounded-2xl shadow-sm p-6 animate-fade-in border border-slate-100">
                        <div className="flex items-center gap-2 mb-6">
                             <button onClick={() => setIsCreating(false)} className="p-2 -ml-2 text-slate-400 hover:text-slate-600"><IconArrowLeft className="w-6 h-6" /></button>
                             <h2 className="text-xl font-bold text-slate-800">
                                アカウントを追加
                             </h2>
                        </div>
                        
                        <form onSubmit={handleCreate} className="space-y-4">
                            <div>
                                <label className="block text-sm font-bold text-slate-600 mb-1">お名前</label>
                                <input required className="w-full p-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-green-500 outline-none transition" placeholder="山田 太郎" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                            </div>
                            
                            {/* 生年月日入力 */}
                            <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-bold text-blue-800 mb-1">生年月日</label>
                                        <input 
                                            required 
                                            type="date"
                                            className="w-full p-3 border border-blue-200 rounded-xl bg-white focus:ring-2 focus:ring-blue-500 outline-none transition" 
                                            value={formData.birthdate} 
                                            onChange={e => setFormData({...formData, birthdate: e.target.value})} 
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-blue-800 mb-1">年齢・学年 (自動計算)</label>
                                        <div className="w-full p-3 border border-blue-200 rounded-xl bg-white text-blue-900 font-bold min-h-[48px] flex items-center shadow-sm">
                                            {calculatedInfo.label || <span className="text-slate-300 font-normal">生年月日を選択...</span>}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-bold text-slate-600 mb-1">性別</label>
                                    <select className="w-full p-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-green-500 outline-none transition" value={formData.gender} onChange={e => setFormData({...formData, gender: e.target.value})}>
                                        <option value="male">男性</option>
                                        <option value="female">女性</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-slate-600 mb-1">区分</label>
                                    <select className="w-full p-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-green-500 outline-none transition" value={formData.category} onChange={e => setFormData({...formData, category: e.target.value})}>
                                        <option value="member">会員</option>
                                        <option value="sibling">兄弟・姉妹</option>
                                        <option value="parent">保護者</option>
                                    </select>
                                </div>
                            </div>
                            <div className="flex gap-3 mt-6">
                                <button type="button" onClick={() => setIsCreating(false)} className="flex-1 py-3 text-slate-600 font-bold bg-slate-100 rounded-xl btn-press">キャンセル</button>
                                <button type="submit" className="flex-1 py-3 text-white font-bold bg-green-600 rounded-xl shadow-lg shadow-green-100 btn-press">保存して開始</button>
                            </div>
                        </form>
                    </div>
                );
            }

            return (
                <div className="animate-fade-in space-y-6">
                    {/* Add Button Area */}
                    <button 
                        onClick={() => setIsCreating(true)} 
                        className="w-full bg-white p-4 rounded-2xl shadow-sm border-2 border-dashed border-green-300 text-green-600 font-bold flex items-center justify-center gap-2 hover:bg-green-50 transition btn-press group"
                    >
                        <div className="bg-green-100 p-2 rounded-full group-hover:bg-green-200 transition">
                            <IconUserPlus className="w-6 h-6" />
                        </div>
                        <span>新しいメンバーを追加</span>
                    </button>

                    {/* Member List */}
                    <div>
                        <h3 className="text-sm font-bold text-slate-400 mb-3 ml-1">メンバーリスト ({profiles.length})</h3>
                        <div className="grid gap-3">
                            {profiles.map(profile => (
                                <div key={profile.id} className="relative group">
                                    <button onClick={() => onSelect(profile.id)} className="w-full flex items-center p-4 bg-white rounded-xl shadow-sm border border-slate-100 hover:border-green-500 active:bg-green-50 transition-all text-left pr-14">
                                        <div className={`h-12 w-12 rounded-full flex items-center justify-center text-xl font-bold mr-4 shrink-0 ${profile.category === 'member' ? 'bg-blue-100 text-blue-600' : profile.category === 'parent' ? 'bg-purple-100 text-purple-600' : 'bg-orange-100 text-orange-600'}`}>{profile.name[0]}</div>
                                        <div className="flex-1">
                                            <div className="font-bold text-lg text-slate-800">{profile.name}</div>
                                            <div className="text-xs text-slate-500 font-bold">{CATEGORIES[profile.category]} • {profile.age}</div>
                                        </div>
                                        <IconChevronRight className="text-slate-300" />
                                    </button>
                                    <button onClick={(e) => handleDelete(profile.id, e)} className={`absolute right-14 top-1/2 -translate-y-1/2 p-3 rounded-full transition z-10 ${deleteConfirmId === profile.id ? 'bg-red-500 text-white w-auto px-4 text-xs font-bold' : 'text-slate-300 hover:text-red-500'}`}>
                                        {deleteConfirmId === profile.id ? '削除' : <IconTrash className="w-5 h-5" />}
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        function Dashboard({ profile, records, testItems, onRecord, onGroupRecord, multiProfiles }) {
            const [graphItemId, setGraphItemId] = useState('');
            const [activeTab, setActiveTab] = useState('radar'); // radar or history
            const activeItems = testItems.filter(i => i.active);
            const age = useMemo(() => parseAge(profile.age), [profile.age]);

            // Sort ascending for graph line
            const sortedRecords = [...records].sort((a, b) => new Date(a.date) - new Date(b.date));
            const latestRecord = sortedRecords.length > 0 ? sortedRecords[sortedRecords.length - 1] : null;
            const previousRecord = sortedRecords.length > 1 ? sortedRecords[sortedRecords.length - 2] : null;

            useEffect(() => {
                if (!graphItemId && activeItems.length > 0) setGraphItemId(activeItems[0].id);
            }, [activeItems]);

            const radarData = useMemo(() => {
                if (!latestRecord) return [];
                const groupScores = {};
                GROUPS.forEach(g => { groupScores[g] = { currentTotal: 0, prevTotal: 0, count: 0 }; });

                activeItems.forEach(item => {
                    const cVal = latestRecord.values[item.id];
                    const pVal = previousRecord?.values[item.id];
                    const cScore = calculateScore(cVal ?? 0, item, age, profile.gender);
                    const pScore = calculateScore(pVal ?? 0, item, age, profile.gender);

                    if (!groupScores[item.group]) groupScores[item.group] = { currentTotal: 0, prevTotal: 0, count: 0 };
                    if (cVal != null) {
                        groupScores[item.group].currentTotal += cScore;
                        groupScores[item.group].count++;
                    }
                    if (pVal != null) {
                        groupScores[item.group].prevTotal += pScore;
                    }
                });

                return Object.keys(groupScores).map(group => ({
                    subject: group,
                    A: groupScores[group].count > 0 ? groupScores[group].currentTotal / groupScores[group].count : 0,
                    B: groupScores[group].count > 0 ? groupScores[group].prevTotal / groupScores[group].count : 0,
                    fullMark: 100
                })).filter(d => d.A > 0 || d.B > 0 || ['走力', '筋力', '跳躍力'].includes(d.subject));
            }, [latestRecord, previousRecord, activeItems, age, profile.gender]);

            const historyChartData = sortedRecords.map(r => ({
                date: new Date(r.date).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit' }),
                value: r.values[graphItemId]
            }));

            const currentGraphItem = activeItems.find(i => i.id === graphItemId);

            return (
                <div className="space-y-6 animate-fade-in">
                    {/* User Profile Card */}
                    <div className="bg-white rounded-2xl p-5 shadow-sm border border-slate-100 flex items-center justify-between">
                        <div>
                            <div className="text-xs text-slate-400 font-bold mb-1">{CATEGORIES[profile.category]}</div>
                            <h2 className="text-2xl font-bold text-slate-800">{profile.name}<span className="text-sm font-normal text-slate-500 ml-2">さん</span></h2>
                        </div>
                        <div className={`h-12 w-12 rounded-full flex items-center justify-center text-2xl font-bold ${profile.gender === 'male' ? 'bg-blue-50 text-blue-500' : 'bg-pink-50 text-pink-500'}`}>
                            {profile.name[0]}
                        </div>
                    </div>

                    {/* Stats Section */}
                    {latestRecord ? (
                        <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                            {/* Tabs */}
                            <div className="flex border-b border-slate-100">
                                <button onClick={() => setActiveTab('radar')} className={`flex-1 py-3 text-sm font-bold transition ${activeTab === 'radar' ? 'text-green-600 border-b-2 border-green-600 bg-green-50' : 'text-slate-400'}`}>
                                    能力バランス
                                </button>
                                <button onClick={() => setActiveTab('history')} className={`flex-1 py-3 text-sm font-bold transition ${activeTab === 'history' ? 'text-green-600 border-b-2 border-green-600 bg-green-50' : 'text-slate-400'}`}>
                                    成長の記録
                                </button>
                            </div>

                            <div className="p-4">
                                {activeTab === 'radar' && (
                                    <div className="animate-fade-in">
                                        <div className="flex justify-end mb-2">
                                            {previousRecord && (
                                                <div className="text-[10px] flex items-center gap-3 text-slate-500 bg-slate-50 px-2 py-1 rounded-lg">
                                                    <div className="flex items-center gap-1"><div className="w-2 h-2 bg-green-500 rounded-full"></div>今回</div>
                                                    <div className="flex items-center gap-1"><div className="w-2 h-2 bg-slate-300 rounded-full"></div>前回</div>
                                                </div>
                                            )}
                                        </div>
                                        <div className="h-[250px] w-full -ml-2">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <RadarChart cx="50%" cy="50%" outerRadius="70%" data={radarData}>
                                                    <PolarGrid stroke="#e2e8f0" />
                                                    <PolarAngleAxis dataKey="subject" tick={{ fill: '#64748b', fontSize: 11, fontWeight: 'bold' }} />
                                                    <PolarRadiusAxis angle={30} domain={[0, 100]} tick={false} axisLine={false} />
                                                    <Radar name="前回" dataKey="B" stroke="#cbd5e1" strokeWidth={2} fill="#cbd5e1" fillOpacity={0.2} />
                                                    <Radar name="今回" dataKey="A" stroke="#16a34a" strokeWidth={3} fill="#22c55e" fillOpacity={0.4} />
                                                </RadarChart>
                                            </ResponsiveContainer>
                                        </div>
                                        <div className="grid grid-cols-2 gap-2 mt-2">
                                            {activeItems.slice(0, 4).map(item => (
                                                <StatBox key={item.id} label={item.label} value={latestRecord.values[item.id] != null ? `${latestRecord.values[item.id]}${item.unit}` : '-'} />
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'history' && (
                                    <div className="animate-fade-in">
                                        <div className="flex justify-end mb-4">
                                            <select className="text-xs bg-slate-50 border border-slate-200 rounded-lg p-2 outline-none font-bold text-slate-700" value={graphItemId} onChange={(e) => setGraphItemId(e.target.value)}>
                                                {activeItems.map(item => <option key={item.id} value={item.id}>{item.label}</option>)}
                                            </select>
                                        </div>
                                        <div className="h-64 w-full">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <LineChart data={historyChartData} margin={{ top: 10, right: 20, bottom: 5, left: 0 }}>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                                    <XAxis dataKey="date" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} />
                                                    <YAxis stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} width={30} />
                                                    <Tooltip contentStyle={{ borderRadius: '12px', border: 'none', boxShadow: '0 10px 15px -3px rgb(0 0 0 / 0.1)', fontSize: '12px' }} />
                                                    <Line connectNulls type="monotone" dataKey="value" stroke="#3b82f6" strokeWidth={3} dot={{ fill: '#3b82f6', strokeWidth: 2, r: 4, stroke: '#fff' }} activeDot={{ r: 6 }} />
                                                </LineChart>
                                            </ResponsiveContainer>
                                        </div>
                                        <p className="text-center text-xs text-slate-400 mt-2 font-bold">{currentGraphItem?.label} ({currentGraphItem?.unit})</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    ) : (
                        <div className="bg-white rounded-2xl shadow-sm p-10 text-center flex flex-col items-center gap-4 border border-slate-100">
                            <div className="h-20 w-20 bg-green-50 rounded-full flex items-center justify-center mb-2"><IconActivity className="text-green-500 w-10 h-10" /></div>
                            <div>
                                <h3 className="font-bold text-slate-800 text-lg mb-1">まだ記録がありません</h3>
                                <p className="text-slate-400 text-sm">最初のテスト結果を入力して<br />成長のグラフを見てみましょう！</p>
                            </div>
                        </div>
                    )}

                    {/* Actions */}
                    <div className="grid grid-cols-2 gap-3">
                        <button onClick={onRecord} className="bg-green-600 text-white py-4 px-4 rounded-xl font-bold shadow-lg shadow-green-100 flex flex-col items-center justify-center gap-1 btn-press transition">
                            <IconPlus className="w-6 h-6 mb-1" />
                            <span>ひとりで記録</span>
                        </button>
                        {multiProfiles ? (
                            <button onClick={onGroupRecord} className="bg-white text-green-700 border border-green-100 py-4 px-4 rounded-xl font-bold shadow-sm flex flex-col items-center justify-center gap-1 btn-press transition">
                                <IconUsers className="w-6 h-6 mb-1" />
                                <span>みんなで記録</span>
                            </button>
                        ) : (
                            <div className="bg-slate-100 text-slate-400 py-4 px-4 rounded-xl font-bold flex flex-col items-center justify-center gap-1 border border-slate-200">
                                <IconUsers className="w-6 h-6 mb-1" />
                                <span className="text-xs">メンバー追加で利用可</span>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function RecordEntry({ profile, testItems, onBack, onComplete, currentRecords, onUpdateRecords }) {
            const [values, setValues] = useState({});
            const activeItems = testItems.filter(i => i.active);
            const groupedItems = activeItems.reduce((acc, item) => {
                if (!acc[item.group]) acc[item.group] = [];
                acc[item.group].push(item);
                return acc;
            }, {});

            const handleSubmit = (e) => {
                e.preventDefault();
                const cleanValues = {};
                activeItems.forEach(item => {
                    const raw = values[item.id];
                    if (raw !== '' && raw !== undefined) cleanValues[item.id] = Number(raw);
                });

                const newRecord = {
                    id: 'r_' + Date.now(),
                    profileId: profile.id,
                    date: Date.now(),
                    values: cleanValues
                };
                onUpdateRecords([...currentRecords, newRecord]);
                onComplete();
            };

            return (
                <div className="animate-slide-up pb-32">
                    <div className="flex items-center gap-3 mb-6">
                        <button onClick={onBack} className="p-2 -ml-2 text-slate-400 hover:text-slate-600"><IconArrowLeft className="w-6 h-6" /></button>
                        <h2 className="text-xl font-bold">記録を入力</h2>
                    </div>
                    <div className="bg-red-50 text-red-700 p-4 rounded-xl text-sm mb-6 flex items-start gap-3 border border-red-100 shadow-sm">
                        <IconAlert className="w-5 h-5 shrink-0 mt-0.5" />
                        <p className="font-bold">数字はすべて<br/>「半角 (例: 7.5)」で入力してください</p>
                    </div>
                    <form onSubmit={handleSubmit} className="space-y-6">
                        <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 space-y-8">
                            {Object.keys(groupedItems).map((groupName, idx) => (
                                <div key={groupName}>
                                    {idx > 0 && <div className="border-t border-slate-100 my-6" />}
                                    <h3 className="text-sm font-bold text-green-600 uppercase tracking-wider mb-4 flex items-center gap-2">
                                        <div className="w-1 h-4 bg-green-500 rounded-full"></div>
                                        {groupName}
                                    </h3>
                                    <div className="space-y-4">
                                        {groupedItems[groupName].map(item => (
                                            <InputGroup key={item.id} label={item.label} suffix={item.unit} placeholder="-" value={values[item.id] || ''} onChange={(v) => setValues(prev => ({ ...prev, [item.id]: v }))} />
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </form>
                    <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-slate-100 safe-area-pb shadow-lg z-30">
                        <div className="max-w-3xl mx-auto">
                            <button onClick={handleSubmit} className="w-full py-4 bg-green-600 text-white font-bold rounded-xl shadow-lg shadow-green-100 btn-press flex items-center justify-center gap-2 transition">
                                <IconSave className="w-5 h-5" /> 記録を保存
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function GroupRecordView({ profiles, testItems, onBack, onComplete, currentRecords, onUpdateRecords }) {
            const [step, setStep] = useState('select_members');
            const [selectedProfileIds, setSelectedProfileIds] = useState([]);
            const [values, setValues] = useState({});
            const activeItems = testItems.filter(i => i.active);

            const handleSave = () => {
                const newRecords = [];
                const now = Date.now();
                selectedProfileIds.forEach(pid => {
                    const userValues = values[pid] || {};
                    const cleanValues = {};
                    Object.keys(userValues).forEach(itemId => {
                        const val = userValues[itemId];
                        if (val !== '' && val !== undefined) cleanValues[itemId] = Number(val);
                    });
                    if (Object.keys(cleanValues).length > 0) {
                        newRecords.push({
                            id: 'r_' + pid + '_' + now,
                            profileId: pid,
                            date: now,
                            values: cleanValues
                        });
                    }
                });
                onUpdateRecords([...currentRecords, ...newRecords]);
                if (selectedProfileIds.length > 0) onComplete(selectedProfileIds[0]);
                else onBack();
            };

            if (step === 'select_members') {
                return (
                    <div className="animate-fade-in pb-10">
                        <div className="flex items-center gap-3 mb-6">
                            <button onClick={onBack} className="p-2 -ml-2 text-slate-400 hover:text-slate-600"><IconArrowLeft className="w-6 h-6" /></button>
                            <h2 className="text-xl font-bold">参加者を選択</h2>
                        </div>
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 text-center mb-6">
                            <p className="text-slate-800 font-bold mb-1">誰の記録を入力しますか？</p>
                            <p className="text-xs text-slate-400">複数人選ぶと、まとめて入力できます</p>
                        </div>
                        <div className="grid gap-3 mb-24">
                            {profiles.map(profile => {
                                const isSelected = selectedProfileIds.includes(profile.id);
                                return (
                                    <button key={profile.id} onClick={() => setSelectedProfileIds(prev => prev.includes(profile.id) ? prev.filter(p => p !== profile.id) : [...prev, profile.id])} className={`flex items-center p-4 rounded-xl border-2 transition-all text-left ${isSelected ? 'bg-green-50 border-green-500 shadow-sm' : 'bg-white border-transparent shadow-sm'}`}>
                                        <div className={`h-12 w-12 rounded-full flex items-center justify-center text-xl font-bold mr-4 shrink-0 transition-colors ${isSelected ? 'bg-green-100 text-green-600' : 'bg-slate-100 text-slate-400'}`}>{profile.name[0]}</div>
                                        <div className="flex-1 font-bold text-slate-800 text-lg">{profile.name}</div>
                                        <div className={`h-6 w-6 rounded-full border-2 flex items-center justify-center transition-colors ${isSelected ? 'border-green-500 bg-green-500 text-white' : 'border-slate-300'}`}>{isSelected && <IconCheck className="w-4 h-4" />}</div>
                                    </button>
                                );
                            })}
                        </div>
                        <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-slate-100 safe-area-pb z-30">
                            <div className="max-w-3xl mx-auto">
                                <button onClick={() => setStep('input')} disabled={selectedProfileIds.length === 0} className={`w-full py-4 font-bold rounded-xl shadow-lg transition flex items-center justify-center gap-2 ${selectedProfileIds.length > 0 ? 'bg-green-600 text-white btn-press shadow-green-100' : 'bg-slate-200 text-slate-400 cursor-not-allowed'}`}>
                                    次へ進む ({selectedProfileIds.length}人) <IconChevronRight className="w-5 h-5" />
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="animate-slide-up pb-28">
                    <div className="flex items-center gap-3 mb-6 sticky top-16 bg-slate-50 py-2 z-10">
                        <button onClick={() => setStep('select_members')} className="p-2 -ml-2 text-slate-400 hover:text-slate-600"><IconArrowLeft className="w-6 h-6" /></button>
                        <h2 className="text-xl font-bold">まとめて入力</h2>
                    </div>
                    <div className="bg-red-50 text-red-700 p-4 rounded-xl text-sm mb-6 flex items-start gap-3 border border-red-100 shadow-sm">
                        <IconAlert className="w-5 h-5 shrink-0 mt-0.5" />
                        <p className="font-bold">数字はすべて<br/>「半角 (例: 7.5)」で入力してください</p>
                    </div>
                    <div className="space-y-6">
                        {selectedProfileIds.map(pid => {
                            const profile = profiles.find(p => p.id === pid);
                            if (!profile) return null;
                            return (
                                <div key={pid} className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                                    <div className="bg-slate-50 p-4 border-b border-slate-100 flex items-center gap-3">
                                        <div className={`h-10 w-10 rounded-full flex items-center justify-center text-lg font-bold shrink-0 ${profile.category === 'member' ? 'bg-blue-100 text-blue-600' : profile.category === 'parent' ? 'bg-purple-100 text-purple-600' : 'bg-orange-100 text-orange-600'}`}>{profile.name[0]}</div>
                                        <div><div className="font-bold text-slate-800 text-lg">{profile.name}</div><div className="text-xs text-slate-500">{CATEGORIES[profile.category]}</div></div>
                                    </div>
                                    <div className="p-4 space-y-4">
                                        {activeItems.map(item => (
                                            <div key={item.id} className="flex items-center justify-between gap-4 border-b border-slate-50 last:border-0 pb-2 last:pb-0">
                                                <div className="flex-1"><div className="font-bold text-slate-700 text-sm">{item.label}</div><div className="text-[10px] text-slate-400">{item.group}</div></div>
                                                <div className="w-32 relative">
                                                    <input type="number" step="0.1" className="w-full p-2 pr-8 bg-slate-50 border border-slate-200 rounded-lg font-bold text-lg text-right focus:ring-2 focus:ring-green-500 outline-none transition" placeholder="-" value={(values[pid] && values[pid][item.id]) || ''} onChange={(e) => setValues(prev => ({ ...prev, [pid]: { ...(prev[pid] || {}), [item.id]: e.target.value } }))} />
                                                    <span className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs font-bold pointer-events-none">{item.unit}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-slate-100 safe-area-pb shadow-lg z-20">
                        <div className="max-w-3xl mx-auto">
                            <button onClick={handleSave} className="w-full py-4 bg-green-600 text-white font-bold rounded-xl shadow-lg shadow-green-100 flex items-center justify-center gap-2 btn-press transition">
                                <IconSave className="w-5 h-5" /> 全員分をまとめて保存
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function HistoryView({ profile, records, testItems, onBack, onUpdateRecords, allRecords }) {
            const [selectedItemId, setSelectedItemId] = useState('');
            const [deleteConfirmId, setDeleteConfirmId] = useState(null);
            const activeItems = testItems.filter(i => i.active);

            useEffect(() => {
                if (!selectedItemId && activeItems.length > 0) setSelectedItemId(activeItems[0].id);
            }, [activeItems]);

            const handleDelete = (recordId, e) => {
                e.stopPropagation();
                if (deleteConfirmId === recordId) {
                    const newAllRecords = allRecords.filter(r => r.id !== recordId);
                    onUpdateRecords(newAllRecords);
                    setDeleteConfirmId(null);
                } else {
                    setDeleteConfirmId(recordId);
                    setTimeout(() => setDeleteConfirmId(null), 3000);
                }
            };

            const sortedRecords = [...records].sort((a, b) => new Date(a.date) - new Date(b.date));
            const chartData = sortedRecords.map(r => ({
                date: new Date(r.date).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit' }),
                value: r.values[selectedItemId]
            }));
            const currentItem = activeItems.find(i => i.id === selectedItemId);

            return (
                <div className="animate-fade-in space-y-6">
                    <div className="flex items-center gap-3 mb-6">
                        <h2 className="text-xl font-bold text-slate-800">成長の記録</h2>
                    </div>
                    {records.length === 0 ? <div className="text-center py-16 text-slate-400 bg-white rounded-2xl border border-slate-100">まだ記録がありません</div> : (
                        <>
                            <div className="bg-white p-3 rounded-2xl shadow-sm border border-slate-100 overflow-x-auto whitespace-nowrap hide-scrollbar flex gap-2">
                                {activeItems.map(item => <button key={item.id} onClick={() => setSelectedItemId(item.id)} className={`inline-block px-4 py-2 rounded-lg text-xs font-bold transition whitespace-nowrap ${selectedItemId === item.id ? 'bg-green-600 text-white shadow-md' : 'bg-slate-100 text-slate-500'}`}>{item.label}</button>)}
                            </div>
                            
                            <div className="space-y-3">
                                {sortedRecords.length > 0 && <div className="text-xs font-bold text-slate-400 ml-2">履歴 ({sortedRecords.length}件)</div>}
                                {[...sortedRecords].reverse().map(record => (
                                    <div key={record.id} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center group">
                                        <div className="flex items-center gap-3">
                                            <div className="bg-green-50 p-2 rounded-lg text-green-600"><IconCalendar className="w-5 h-5" /></div>
                                            <div>
                                                <div className="font-bold text-slate-800 text-sm">{new Date(record.date).toLocaleDateString('ja-JP')}</div>
                                                <div className="text-xs text-slate-400">{new Date(record.date).toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'})}</div>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-4">
                                            <div className="text-right">
                                                {record.values[selectedItemId] != null ? <><span className="text-xl font-bold text-slate-800">{record.values[selectedItemId]}</span><span className="text-xs text-slate-400 font-bold ml-1">{currentItem?.unit}</span></> : <span className="text-sm text-slate-300 font-bold">未実施</span>}
                                            </div>
                                            <button onClick={(e) => handleDelete(record.id, e)} className={`p-2 rounded-full transition ${deleteConfirmId === record.id ? 'bg-red-500 text-white w-16 text-xs font-bold' : 'text-slate-300 hover:text-red-500 hover:bg-red-50'}`}>
                                                {deleteConfirmId === record.id ? '削除' : <IconTrash className="w-5 h-5" />}
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </>
                    )}
                </div>
            );
        }

        function SettingsView({ testItems, onUpdate, onBack }) {
            const [isAdding, setIsAdding] = useState(false);
            const [newParams, setNewParams] = useState({ label: '', unit: '', group: 'その他', type: 'higher_is_better' });

            const toggleActive = (id) => {
                onUpdate(testItems.map(item => item.id === id ? { ...item, active: !item.active } : item));
            };

            const addItem = (e) => {
                e.preventDefault();
                if (!newParams.label) return;
                const newItem = { ...newParams, id: 'custom_' + Date.now(), active: true, order: testItems.length + 1 };
                onUpdate([...testItems, newItem]);
                setIsAdding(false);
                setNewParams({ label: '', unit: '', group: 'その他', type: 'higher_is_better' });
            };

            return (
                <div className="animate-fade-in pb-10">
                    <div className="flex items-center gap-3 mb-6">
                        <button onClick={onBack} className="p-2 -ml-2 text-slate-400 hover:text-slate-600"><IconArrowLeft className="w-6 h-6" /></button>
                        <h2 className="text-xl font-bold">種目設定</h2>
                    </div>
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 className="font-bold text-slate-700">登録済みの種目</h3>
                            <button onClick={() => setIsAdding(!isAdding)} className="text-sm bg-green-600 text-white px-3 py-1.5 rounded-lg flex items-center gap-1 font-bold hover:bg-green-700 transition"><IconPlus className="w-4 h-4" /> 追加</button>
                        </div>
                        {isAdding && (
                            <form onSubmit={addItem} className="p-4 bg-green-50 border-b border-green-100 space-y-3">
                                <div><label className="text-xs font-bold text-green-800">種目名</label><input required className="w-full p-2 rounded-lg border border-green-200" placeholder="例: ハンドボール投げ" value={newParams.label} onChange={e => setNewParams({...newParams, label: e.target.value})} /></div>
                                <div className="flex gap-3">
                                    <div className="flex-1"><label className="text-xs font-bold text-green-800">単位</label><input required className="w-full p-2 rounded-lg border border-green-200" placeholder="m, 秒, 回" value={newParams.unit} onChange={e => setNewParams({...newParams, unit: e.target.value})} /></div>
                                    <div className="flex-1"><label className="text-xs font-bold text-green-800">カテゴリー</label><select className="w-full p-2 rounded-lg border border-green-200 bg-white" value={newParams.group} onChange={e => setNewParams({...newParams, group: e.target.value})}>{GROUPS.map(g => <option key={g} value={g}>{g}</option>)}</select></div>
                                </div>
                                <div><label className="text-xs font-bold text-green-800">評価タイプ</label><select className="w-full p-2 rounded-lg border border-green-200 bg-white" value={newParams.type} onChange={e => setNewParams({...newParams, type: e.target.value})}><option value="higher_is_better">数値が高いほど良い</option><option value="lower_is_better">数値が低いほど良い</option></select></div>
                                <div className="flex justify-end gap-2 mt-2"><button type="button" onClick={() => setIsAdding(false)} className="text-xs text-slate-500 font-bold px-3 py-2">キャンセル</button><button type="submit" className="text-xs bg-green-600 text-white font-bold px-4 py-2 rounded-lg shadow-sm">追加する</button></div>
                            </form>
                        )}
                        <div className="divide-y divide-slate-100">
                            {testItems.map(item => (
                                <div key={item.id} className={`p-4 flex items-center justify-between transition ${!item.active ? 'bg-slate-50 opacity-60' : 'hover:bg-slate-50'}`}>
                                    <div>
                                        <div className="font-bold text-slate-800 flex items-center gap-2">{item.label}{!item.active && <span className="text-[10px] bg-slate-200 text-slate-500 px-1.5 py-0.5 rounded font-bold">非表示</span>}</div>
                                        <div className="text-xs text-slate-400 mt-0.5 font-medium">{item.group} • 単位: {item.unit}</div>
                                    </div>
                                    <button onClick={() => toggleActive(item.id)} className={`p-2 rounded-full transition ${item.active ? 'text-green-600 hover:bg-green-50' : 'text-slate-400 hover:bg-slate-200'}`} title={item.active ? '非表示にする' : '表示する'}>{item.active ? <IconEye className="w-5 h-5" /> : <IconEyeOff className="w-5 h-5" />}</button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
